<!doctype html>
<html lang="zh-Hant-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å¤–é€ä»»å‹™éŠæˆ²ï½œMcD é¢¨æ ¼</title>
  <style>
    :root{
      --mcd-red:#DB0007;
      --mcd-yellow:#FFC72C;
      --mcd-white:#FFFFFF;
      --text:#1F1F1F;
      --muted:#5C5C5C;
      --card:#FFFFFF;
      --border:rgba(0,0,0,.10);
      --shadow:0 10px 30px rgba(0,0,0,.14);
      --radius:18px;
      --focus: 0 0 0 4px rgba(255,199,44,.45);
      --good: #0f7b3d;
      --bad: #b00020;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 500px at 15% 0%, rgba(255,199,44,.35), transparent 55%),
        radial-gradient(900px 500px at 90% 15%, rgba(219,0,7,.25), transparent 60%),
        linear-gradient(180deg, #fff 0%, #fff7df 55%, #ffffff 100%);
    }
    .container{max-width:1000px;margin:0 auto;padding:22px 16px 48px}
    .hero{
      position:relative;
      background: linear-gradient(135deg, var(--mcd-red) 0%, #b60005 60%, #9d0004 100%);
      color: var(--mcd-white);
      border-radius: 26px;
      padding: 18px 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-80px -120px auto auto;
      width:320px;height:320px;
      background: radial-gradient(circle at 30% 30%, rgba(255,199,44,.95), rgba(255,199,44,.25) 55%, transparent 70%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .logo{
      width:46px;height:46px;border-radius:14px;
      background: linear-gradient(180deg, var(--mcd-yellow), #ffdd6b);
      display:grid;place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .logo span{font-weight:900;font-size:24px;color:var(--mcd-red);line-height:1}
    h1{margin:0;font-size:clamp(18px,2.5vw,28px);letter-spacing:.2px}
    .sub{margin:6px 0 0;color:rgba(255,255,255,.92);line-height:1.6;max-width:80ch}
    .top-actions{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:0;border-radius:999px;padding:10px 14px;
      cursor:pointer;font-weight:800;font-size:13.5px;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      transition: transform .05s ease, filter .15s ease, box-shadow .15s ease;
      user-select:none;
      text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;
      min-height:38px;
    }
    .btn:active{transform: translateY(1px)}
    .btn-primary{background:var(--mcd-yellow);color:#2a2100}
    .btn-ghost{background:rgba(255,255,255,.88);color:var(--text);border:1px solid var(--border)}
    .btn:focus-visible{outline:none;box-shadow:var(--focus)}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    .card{
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 26px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .card-h{
      padding:12px 14px;
      background: linear-gradient(90deg, rgba(255,199,44,.25), rgba(255,255,255,0));
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card-h h2{margin:0;font-size:15.5px}
    .pill{
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;
      border:1px solid rgba(219,0,7,.18);
      background: rgba(219,0,7,.08);
      color: var(--mcd-red);
      white-space:nowrap;
    }
    .card-b{padding:14px}
    .hud{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .stat{
      background:#fff;
      border:1px solid var(--border);
      border-radius: 16px;
      padding:10px 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .stat .k{color:var(--muted);font-size:12.5px;font-weight:800}
    .stat .v{margin-top:6px;font-size:18px;font-weight:900;letter-spacing:.2px}
    .progress{
      margin-top:12px;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 999px;
      overflow:hidden;
      height: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .bar{height:100%;width:0%}
    .steps{
      margin-top:12px;
      display:grid;
      gap:10px;
    }
    .step{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }
    .icon{
      width:36px;height:36px;border-radius:14px;
      display:grid;place-items:center;
      font-weight:900;
      background: rgba(255,199,44,.28);
      color:#2a2100;
      flex:0 0 auto;
    }
    .step h3{margin:0;font-size:14px}
    .step p{margin:6px 0 0;color:var(--muted);line-height:1.55;font-size:13px}
    .step .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .mini{
      border-radius:999px;border:1px solid var(--border);
      padding:8px 10px;background:rgba(255,255,255,.95);
      font-weight:900;font-size:12.5px;cursor:pointer;
    }
    .mini:disabled{opacity:.45;cursor:not-allowed}
    .msg{
      margin-top:12px;
      border-radius:16px;
      padding:12px;
      border: 1px dashed rgba(0,0,0,.18);
      background: rgba(255,255,255,.7);
      color: var(--text);
      line-height:1.6;
      font-size:13.5px;
    }
    .msg.good{border-color: rgba(15,123,61,.35); background: rgba(15,123,61,.06)}
    .msg.bad{border-color: rgba(176,0,32,.35); background: rgba(176,0,32,.06)}
    .map{
      position:relative;
      height: 420px;
      background: #fff;
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .lane{
      position:absolute;inset:0;
      background:
        linear-gradient(90deg, rgba(255,199,44,.12), rgba(255,255,255,0) 55%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0 2px, transparent 2px 14px);
      opacity:.9;
    }
    .home, .store{
      position:absolute;
      width:120px;height:90px;
      border-radius:18px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.95);
      display:flex;flex-direction:column;justify-content:center;
      padding:10px 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    .store{left:16px;top:18px}
    .home{right:16px;bottom:18px}
    .tag{font-size:12px;color:var(--muted);font-weight:900}
    .label{margin-top:6px;font-weight:1000;letter-spacing:.2px}
    .car{
      position:absolute;
      width:48px;height:48px;
      border-radius: 18px;
      border:1px solid rgba(219,0,7,.22);
      background: rgba(219,0,7,.10);
      display:grid;place-items:center;
      font-size:22px;
      box-shadow: 0 14px 30px rgba(0,0,0,.16);
      left: 46px;
      top: 130px;
      transition: left .18s linear, top .18s linear;
    }
    .tip{margin-top:10px;color:var(--muted);font-size:13px;line-height:1.6}
    @media (max-width: 860px){
      .grid{grid-template-columns:1fr}
      .map{height: 360px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero">
      <div class="row">
        <div class="logo" aria-hidden="true"><span>M</span></div>
        <div style="flex:1 1 auto;">
          <h1>å¤–é€ä»»å‹™éŠæˆ²ï¼šæº–æ™‚é€é”æ‹¿ç©åˆ†</h1>
          <p class="sub">æµç¨‹ï¼šæ¥å–® â†’ å‚™é¤ â†’ è£è»Š â†’ é–‹è»Šé…é€ â†’ åœ¨æ™‚é™å…§é€é”å¾—åˆ†ã€‚æ¯å±€æœƒéš¨æ©Ÿå‡ºç¾ä¸åŒè¨‚å–®é›£åº¦èˆ‡æ™‚é–“é™åˆ¶ã€‚</p>
        </div>
      </div>
      <div class="top-actions">
        <a class="btn btn-ghost" href="./index.html">è¿”å› FAQ</a>
        <button class="btn btn-primary" id="startBtn" type="button">é–‹å§‹æ–°è¨‚å–®</button>
        <button class="btn btn-ghost" id="resetBtn" type="button">é‡ç½®ç©åˆ†</button>
      </div>
    </header>

    <main class="grid">
      <section class="card">
        <div class="card-h">
          <h2>ä»»å‹™é¢æ¿</h2>
          <div class="pill" id="statePill">å¾…æ©Ÿä¸­</div>
        </div>
        <div class="card-b">
          <div class="hud">
            <div class="stat">
              <div class="k">å€’æ•¸æ™‚é–“</div>
              <div class="v"><span id="timeLeft">--</span> ç§’</div>
            </div>
            <div class="stat">
              <div class="k">ç©åˆ†</div>
              <div class="v" id="score">0</div>
            </div>
            <div class="stat">
              <div class="k">æœ¬å–®é›£åº¦</div>
              <div class="v" id="difficulty">--</div>
            </div>
            <div class="stat">
              <div class="k">çå‹µä¿‚æ•¸</div>
              <div class="v" id="multiplier">--</div>
            </div>
          </div>

          <div class="progress" aria-label="è¨‚å–®é€²åº¦">
            <div class="bar" id="progressBar"></div>
          </div>

          <div class="steps" id="steps">
            <div class="step">
              <div class="icon">1</div>
              <div>
                <h3>æ¥æ”¶è¨‚å–®</h3>
                <p>ç¢ºèªè¨‚å–®è³‡è¨Šï¼Œç³»çµ±é–‹å§‹è¨ˆæ™‚ã€‚</p>
              </div>
              <div class="right">
                <button class="mini" id="btnAccept" disabled>æ¥å–®</button>
              </div>
            </div>

            <div class="step">
              <div class="icon">2</div>
              <div>
                <h3>æº–å‚™è¨‚å–®</h3>
                <p>ä¾è¨‚å–®é‡å‚™é¤ï¼Œæ™‚é–“è¶Šä¹…è¶Šå®¹æ˜“è¶…æ™‚ã€‚</p>
              </div>
              <div class="right">
                <button class="mini" id="btnPrep" disabled>å‚™é¤å®Œæˆ</button>
              </div>
            </div>

            <div class="step">
              <div class="icon">3</div>
              <div>
                <h3>æ”¾é€²è»Šå…§</h3>
                <p>å®ŒæˆåŒ…è£æª¢æŸ¥ä¸¦è£è»Šï¼Œæº–å‚™å‡ºç™¼ã€‚</p>
              </div>
              <div class="right">
                <button class="mini" id="btnLoad" disabled>è£è»Šå®Œæˆ</button>
              </div>
            </div>

            <div class="step">
              <div class="icon">4</div>
              <div>
                <h3>é–‹è»Šé…é€</h3>
                <p>ç”¨æ–¹å‘éµç§»å‹•è»Šå­åˆ°å®¢æˆ¶å®¶ï¼›åˆ°é”å¾Œå®Œæˆé€é¤ã€‚</p>
              </div>
              <div class="right">
                <button class="mini" id="btnDrive" disabled>é–‹å§‹é–‹è»Š</button>
              </div>
            </div>

            <div class="step">
              <div class="icon">5</div>
              <div>
                <h3>é€é”å®Œæˆ</h3>
                <p>åœ¨æ™‚é–“å…§é€é”å¯å¾—åˆ†ï¼›è¶Šå¿«åˆ†æ•¸è¶Šé«˜ã€‚</p>
              </div>
              <div class="right">
                <button class="mini" id="btnDeliver" disabled>å®Œæˆé€é”</button>
              </div>
            </div>
          </div>

          <div class="msg" id="message">
            é»ã€Œé–‹å§‹æ–°è¨‚å–®ã€å¾Œé€²å…¥ä»»å‹™æµç¨‹ã€‚æç¤ºï¼šé…é€éšæ®µç”¨éµç›¤æ–¹å‘éµç§»å‹•ğŸš—ã€‚
          </div>

          <div class="tip">
            è¨ˆåˆ†è¦å‰‡ï¼ˆå¯æ”¹ï¼‰ï¼šæˆåŠŸé€é”å¾—åˆ† = åŸºç¤åˆ† Ã— é›£åº¦ä¿‚æ•¸ Ã— é€Ÿåº¦åŠ æˆï¼ˆå‰©é¤˜æ™‚é–“æ¯”ä¾‹ï¼‰ã€‚è¶…æ™‚å‰‡æ­¤å–®å¤±æ•—ä¸åŠ åˆ†ã€‚
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="card-h">
          <h2>é…é€åœ°åœ–</h2>
          <div class="pill" id="mapPill">æœªå‡ºç™¼</div>
        </div>
        <div class="card-b">
          <div class="map" id="map">
            <div class="lane"></div>

            <div class="store" aria-label="é–€å¸‚">
              <div class="tag">èµ·é»</div>
              <div class="label">éº¥ç•¶å‹é–€å¸‚</div>
            </div>

            <div class="home" aria-label="å®¢æˆ¶å®¶">
              <div class="tag">çµ‚é»</div>
              <div class="label">å®¢æˆ¶å®¶</div>
            </div>

            <div class="car" id="car" aria-label="å¤–é€è»Š">ğŸš—</div>
          </div>

          <div class="tip">
            é…é€éšæ®µï¼š
            <ul style="margin:8px 0 0 18px; padding:0;">
              <li>æŒ‰ã€Œé–‹å§‹é–‹è»Šã€é€²å…¥é…é€</li>
              <li>ç”¨éµç›¤æ–¹å‘éµç§»å‹•è»Šå­</li>
              <li>è»Šå­é€²å…¥ã€Œå®¢æˆ¶å®¶ã€å€åŸŸå¾Œå³å¯é»ã€Œå®Œæˆé€é”ã€</li>
            </ul>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // ---------- Game State ----------
    const State = {
      IDLE: "IDLE",
      READY: "READY",         // after new order created
      ACCEPTED: "ACCEPTED",
      PREPPED: "PREPPED",
      LOADED: "LOADED",
      DRIVING: "DRIVING",
      ARRIVED: "ARRIVED",
      DONE: "DONE",
      FAILED: "FAILED",
    };

    const els = {
      startBtn: document.getElementById("startBtn"),
      resetBtn: document.getElementById("resetBtn"),
      statePill: document.getElementById("statePill"),
      mapPill: document.getElementById("mapPill"),
      timeLeft: document.getElementById("timeLeft"),
      score: document.getElementById("score"),
      difficulty: document.getElementById("difficulty"),
      multiplier: document.getElementById("multiplier"),
      progressBar: document.getElementById("progressBar"),
      message: document.getElementById("message"),
      btnAccept: document.getElementById("btnAccept"),
      btnPrep: document.getElementById("btnPrep"),
      btnLoad: document.getElementById("btnLoad"),
      btnDrive: document.getElementById("btnDrive"),
      btnDeliver: document.getElementById("btnDeliver"),
      map: document.getElementById("map"),
      car: document.getElementById("car"),
    };

    let game = {
      state: State.IDLE,
      score: 0,
      timeLimit: 0,
      timeLeft: 0,
      timerId: null,
      difficulty: "â€”",
      multiplier: 1,
      basePoints: 100,
      drivingEnabled: false,
      // car position
      carX: 46,
      carY: 130,
      step: 14
    };

    function setPill(text, mode){
      els.statePill.textContent = text;
      if(mode === "good"){
        els.statePill.style.background = "rgba(15,123,61,.10)";
        els.statePill.style.borderColor = "rgba(15,123,61,.22)";
        els.statePill.style.color = "var(--good)";
      } else if(mode === "bad"){
        els.statePill.style.background = "rgba(176,0,32,.10)";
        els.statePill.style.borderColor = "rgba(176,0,32,.22)";
        els.statePill.style.color = "var(--bad)";
      } else {
        els.statePill.style.background = "rgba(219,0,7,.08)";
        els.statePill.style.borderColor = "rgba(219,0,7,.18)";
        els.statePill.style.color = "var(--mcd-red)";
      }
    }
    function setMsg(text, type){
      els.message.classList.remove("good","bad");
      if(type) els.message.classList.add(type);
      els.message.textContent = text;
    }

    function updateUI(){
      els.score.textContent = String(game.score);
      els.timeLeft.textContent = game.timeLeft ? String(game.timeLeft) : "--";
      els.difficulty.textContent = game.difficulty;
      els.multiplier.textContent = game.multiplier ? `Ã—${game.multiplier.toFixed(1)}` : "--";

      // progress: 5 steps
      const progressMap = {
        [State.IDLE]: 0,
        [State.READY]: 5,
        [State.ACCEPTED]: 20,
        [State.PREPPED]: 45,
        [State.LOADED]: 65,
        [State.DRIVING]: 80,
        [State.ARRIVED]: 90,
        [State.DONE]: 100,
        [State.FAILED]: 100
      };
      const p = progressMap[game.state] ?? 0;
      els.progressBar.style.width = p + "%";
      // use implicit colors (do not set explicit palette here)

      // buttons
      els.btnAccept.disabled = !(game.state === State.READY);
      els.btnPrep.disabled = !(game.state === State.ACCEPTED);
      els.btnLoad.disabled = !(game.state === State.PREPPED);
      els.btnDrive.disabled = !(game.state === State.LOADED);
      els.btnDeliver.disabled = !(game.state === State.ARRIVED);

      // map pill
      if(game.state === State.DRIVING) els.mapPill.textContent = "é…é€ä¸­";
      else if(game.state === State.ARRIVED) els.mapPill.textContent = "å·²åˆ°é”";
      else if(game.state === State.DONE) els.mapPill.textContent = "å·²å®Œæˆ";
      else if(game.state === State.FAILED) els.mapPill.textContent = "å·²å¤±æ•—";
      else els.mapPill.textContent = "æœªå‡ºç™¼";
    }

    function stopTimer(){
      if(game.timerId){
        clearInterval(game.timerId);
        game.timerId = null;
      }
    }

    function startTimer(){
      stopTimer();
      game.timerId = setInterval(() => {
        if(game.state === State.DONE || game.state === State.FAILED) return;
        game.timeLeft -= 1;
        if(game.timeLeft <= 0){
          game.timeLeft = 0;
          failOrder("è¶…éè¦å®šæ™‚é–“ï¼Œè¨‚å–®å¤±æ•—ã€‚å»ºè­°ï¼šå°–å³°æ™‚æ®µå„ªå…ˆè£è»Šå‡ºç™¼ï¼Œé™ä½å»¶é²é¢¨éšªã€‚");
        }
        updateUI();
      }, 1000);
    }

    function newOrder(){
      stopTimer();
      // random difficulty
      const roll = Math.random();
      if(roll < 0.45){
        game.difficulty = "ä¸€èˆ¬";
        game.multiplier = 1.0;
        game.timeLimit = 60;
      } else if(roll < 0.80){
        game.difficulty = "ç¹å¿™";
        game.multiplier = 1.3;
        game.timeLimit = 50;
      } else {
        game.difficulty = "å°–å³°/æƒ¡å¤©å€™";
        game.multiplier = 1.6;
        game.timeLimit = 45;
      }
      game.timeLeft = game.timeLimit;
      game.state = State.READY;
      game.drivingEnabled = false;

      // reset car position near store
      game.carX = 46;
      game.carY = 130;
      renderCar();

      setPill("ç­‰å¾…æ¥å–®", "normal");
      setMsg(`æ–°è¨‚å–®å·²ç”Ÿæˆï¼ˆé›£åº¦ï¼š${game.difficulty}ï¼‰ã€‚è«‹å…ˆæŒ‰ã€Œæ¥å–®ã€é–‹å§‹è¨ˆæ™‚èˆ‡æµç¨‹ã€‚`);
      updateUI();
    }

    function acceptOrder(){
      game.state = State.ACCEPTED;
      setPill("å·²æ¥å–®", "normal");
      setMsg("å·²æ¥æ”¶è¨‚å–®ã€‚ä¸‹ä¸€æ­¥ï¼šå®Œæˆå‚™é¤ï¼ˆå‚™é¤å®Œæˆå¾Œå†è£è»Šï¼‰ã€‚");
      // start countdown once accepted
      startTimer();
      updateUI();
    }

    function prepDone(){
      // simulate prep consumes time (penalty)
      // You can tune these numbers
      const penalty = (game.difficulty === "ä¸€èˆ¬") ? 6 : (game.difficulty === "ç¹å¿™") ? 8 : 10;
      game.timeLeft = Math.max(0, game.timeLeft - penalty);

      game.state = State.PREPPED;
      setPill("å‚™é¤å®Œæˆ", "normal");
      setMsg(`å‚™é¤å®Œæˆï¼ˆè€—æ™‚-${penalty}sï¼‰ã€‚ä¸‹ä¸€æ­¥ï¼šè£è»Šã€‚`);
      updateUI();
    }

    function loadDone(){
      const penalty = (game.difficulty === "ä¸€èˆ¬") ? 4 : (game.difficulty === "ç¹å¿™") ? 5 : 6;
      game.timeLeft = Math.max(0, game.timeLeft - penalty);

      game.state = State.LOADED;
      setPill("å·²è£è»Š", "normal");
      setMsg(`è£è»Šå®Œæˆï¼ˆè€—æ™‚-${penalty}sï¼‰ã€‚ä¸‹ä¸€æ­¥ï¼šé–‹å§‹é–‹è»Šé…é€ã€‚`);
      updateUI();
    }

    function startDriving(){
      game.state = State.DRIVING;
      game.drivingEnabled = true;
      setPill("é…é€ä¸­", "normal");
      setMsg("é…é€é–‹å§‹ï¼ä½¿ç”¨æ–¹å‘éµç§»å‹•è»Šå­åˆ°ã€Œå®¢æˆ¶å®¶ã€å€åŸŸã€‚åˆ°é”å¾Œå¯é»ã€Œå®Œæˆé€é”ã€ã€‚");
      updateUI();
    }

    function arrived(){
      game.state = State.ARRIVED;
      game.drivingEnabled = false;
      setPill("å·²åˆ°é”", "good");
      setMsg("ä½ å·²åˆ°é”å®¢æˆ¶å®¶ï¼é»ã€Œå®Œæˆé€é”ã€çµç®—ç©åˆ†ã€‚", "good");
      updateUI();
    }

    function deliver(){
      // score formula: basePoints * multiplier * (0.5 + timeLeft/timeLimit)
      const speedFactor = 0.5 + (game.timeLeft / game.timeLimit);
      const gained = Math.round(game.basePoints * game.multiplier * speedFactor);

      game.score += gained;
      game.state = State.DONE;
      game.drivingEnabled = false;
      stopTimer();

      setPill("é€é”æˆåŠŸ", "good");
      setMsg(`é€é”æˆåŠŸï¼ç²å¾— ${gained} åˆ†ï¼ˆé€Ÿåº¦åŠ æˆï¼š${speedFactor.toFixed(2)}ï¼‰ã€‚å¯å†æŒ‰ã€Œé–‹å§‹æ–°è¨‚å–®ã€æŒ‘æˆ°ä¸‹ä¸€å–®ã€‚`, "good");
      updateUI();
    }

    function failOrder(reason){
      game.state = State.FAILED;
      game.drivingEnabled = false;
      stopTimer();
      setPill("è¨‚å–®å¤±æ•—", "bad");
      setMsg(reason || "è¨‚å–®å¤±æ•—ã€‚å¯æŒ‰ã€Œé–‹å§‹æ–°è¨‚å–®ã€é‡æ–°æŒ‘æˆ°ã€‚", "bad");
      updateUI();
    }

    // ---------- Movement / Collision ----------
    function renderCar(){
      els.car.style.left = game.carX + "px";
      els.car.style.top = game.carY + "px";
    }

    function isInsideHome(){
      // home box is at bottom-right: we can compute based on map size
      const mapRect = els.map.getBoundingClientRect();
      // home element is positioned: right 16, bottom 18, size 120x90
      // We'll approximate with percentages using current map client size
      const homeX = mapRect.width - 16 - 120;
      const homeY = mapRect.height - 18 - 90;

      // car box (48x48)
      const carW = 48, carH = 48;

      const cx = game.carX;
      const cy = game.carY;

      // overlap threshold
      const overlapX = (cx + carW) > homeX && cx < (homeX + 120);
      const overlapY = (cy + carH) > homeY && cy < (homeY + 90);
      return overlapX && overlapY;
    }

    function clampCar(){
      // keep within map bounds
      const mapRect = els.map.getBoundingClientRect();
      const maxX = mapRect.width - 48;
      const maxY = mapRect.height - 48;
      game.carX = Math.max(0, Math.min(maxX, game.carX));
      game.carY = Math.max(0, Math.min(maxY, game.carY));
    }

    window.addEventListener("keydown", (e) => {
      if(!game.drivingEnabled) return;

      const key = e.key;
      let moved = false;

      if(key === "ArrowUp"){ game.carY -= game.step; moved = true; }
      else if(key === "ArrowDown"){ game.carY += game.step; moved = true; }
      else if(key === "ArrowLeft"){ game.carX -= game.step; moved = true; }
      else if(key === "ArrowRight"){ game.carX += game.step; moved = true; }

      if(moved){
        e.preventDefault();
        clampCar();
        renderCar();
        // arrived check
        if(isInsideHome()){
          arrived();
        }
      }
    }, {passive:false});

    // ---------- Wire UI ----------
    els.startBtn.addEventListener("click", newOrder);
    els.resetBtn.addEventListener("click", () => {
      game.score = 0;
      setMsg("ç©åˆ†å·²é‡ç½®ã€‚å¯æŒ‰ã€Œé–‹å§‹æ–°è¨‚å–®ã€é‡æ–°æŒ‘æˆ°ã€‚");
      updateUI();
    });
    els.btnAccept.addEventListener("click", acceptOrder);
    els.btnPrep.addEventListener("click", prepDone);
    els.btnLoad.addEventListener("click", loadDone);
    els.btnDrive.addEventListener("click", startDriving);
    els.btnDeliver.addEventListener("click", deliver);

    // Initial UI
    setPill("å¾…æ©Ÿä¸­", "normal");
    updateUI();
    renderCar();
  </script>
</body>
</html>
